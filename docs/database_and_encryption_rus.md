
## Stage 1 - –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º

---

### 1. –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è Stage 1
**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (SQLite), –∫–æ—Ç–æ—Ä–∞—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —à–∏—Ñ—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –Ω–∞ –¥–∏—Å–∫ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∏—Ö –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏.

**–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:** –ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (UI) —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ (Dart classes), –∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω–∏—Ç "—á–µ—Ä–Ω—ã–π —è—â–∏–∫" (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞–π—Ç—ã). –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ.

---

### 2. –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### –ê. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (`TransactionData`)
–≠—Ç–æ —á–∏—Å—Ç—ã–π Dart-–∫–ª–∞—Å—Å (–∏—Å–ø–æ–ª—å–∑—É–µ–º `Freezed`), –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—ë, —á—Ç–æ –º—ã —Ö–æ—Ç–∏–º —Å–∫—Ä—ã—Ç—å:
*   –°—É–º–º–∞ (`amount`)
*   –û–ø–∏—Å–∞–Ω–∏–µ (`description`)
*   –ö–∞—Ç–µ–≥–æ—Ä–∏—è (`category`)
*   –í–∞–ª—é—Ç–∞ (`currency`)

**–í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å:** –í –ø—Ä–æ–º–ø—Ç–µ —Å–∫–∞–∑–∞–Ω–æ: *"Include ID and Date inside the JSON model to verify integrity"*.
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ JSON –º—ã –¥—É–±–ª–∏—Ä—É–µ–º `id` –∏ `date`.
*   **–ó–∞—á–µ–º?** –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–º–µ–Ω—ã (Anti-Tampering). –ï—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ (–∏–ª–∏ "–±–∞–≥" —Å–µ—Ä–≤–µ—Ä–∞) –≤–æ–∑—å–º–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–± –æ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ "–ü–æ–∫—É–ø–∫–∞ –∫–æ—Ñ–µ –∑–∞ $5" –∏ –ø–æ–¥—Å—É–Ω–µ—Ç –µ–≥–æ –≤ —Å—Ç—Ä–æ–∫—É —Å ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ "–ó–∞—Ä–ø–ª–∞—Ç–∞ $5000", –ø—Ä–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–µ –º—ã —É–≤–∏–¥–∏–º:
    *   ID —Å—Ç—Ä–æ–∫–∏ –≤ –ë–î: `uuid-1` (–ó–∞—Ä–ø–ª–∞—Ç–∞)
    *   ID –≤–Ω—É—Ç—Ä–∏ JSON: `uuid-2` (–ö–æ—Ñ–µ)
    *   **–†–ï–ó–£–õ–¨–¢–ê–¢:** –ú—ã –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`SecurityException`).

#### –ë. –¢–∞–±–ª–∏—Ü–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`Transactions`)
–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Drift (SQLite) —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—É–¥–µ—Ç –≥–∏–±—Ä–∏–¥–Ω–æ–π. –ú—ã –Ω–µ —à–∏—Ñ—Ä—É–µ–º –≤—Å—ë –ø–æ–¥—Ä—è–¥, –∏–Ω–∞—á–µ –±–∞–∑–∞ —Å—Ç–∞–Ω–µ—Ç –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ–π –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ | –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ? | –ó–∞—á–µ–º –Ω—É–∂–Ω–æ? |
| :--- | :--- | :--- | :--- | :--- |
| `id` | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID | **–ù–ï–¢** | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á, –Ω—É–∂–µ–Ω –¥–ª—è —Å–≤—è–∑–µ–π. |
| `date` | Int | Unix Timestamp | **–ù–ï–¢** | –ß—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ –¥–∞—Ç–µ (`ORDER BY date`) –±–µ–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫. |
| `last_updated_at` | Int | Timestamp | **–ù–ï–¢** | –î–ª—è –ª–æ–≥–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Last Write Wins). |
| `is_deleted` | Bool | –§–ª–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è | **–ù–ï–¢** | "–ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ". –ú—ã –Ω–µ —Å—Ç–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É, –∞ –ø–æ–º–µ—á–∞–µ–º –µ—ë —É–¥–∞–ª–µ–Ω–Ω–æ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. |
| `encrypted_blob` | Blob | Uint8List | **–î–ê** | –ó–¥–µ—Å—å –ª–µ–∂–∏—Ç JSON `TransactionData`, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º AES-GCM (–∏–ª–∏ ChaCha20). –î–ª—è SQLite —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö –±–∞–π—Ç. |

#### –í. –ú–∞–≥–∏—è Drift: `TypeConverter`
Drift –∏–º–µ–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º `TypeConverter`. –≠—Ç–æ "–º–æ—Å—Ç" –º–µ–∂–¥—É Dart –∏ SQL.

1.  **–ü—Ä–∏ –∑–∞–ø–∏—Å–∏ (INSERT/UPDATE):**
    *   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç `TransactionData`.
    *   –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –≤ JSON-—Å—Ç—Ä–æ–∫—É.
    *   –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –±–µ—Ä–µ—Ç **–ö–ª—é—á –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è** (–ø–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫—É, –ø–æ–∑–∂–µ ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π –∫–ª—é—á).
    *   –®–∏—Ñ—Ä—É–µ—Ç JSON –≤ –±–∞–π—Ç—ã (Ciphertext).
    *   Drift –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —ç—Ç–∏ –±–∞–π—Ç—ã –≤ –∫–æ–ª–æ–Ω–∫—É `encrypted_blob`.

2.  **–ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ (SELECT):**
    *   Drift —á–∏—Ç–∞–µ—Ç –±–∞–π—Ç—ã –∏–∑ `encrypted_blob`.
    *   –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∏—Ö –∫–ª—é—á–æ–º.
    *   –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç JSON –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—ä–µ–∫—Ç `TransactionData`.
    *   **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏:** –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `id` –∏–∑ JSON —Å `id` –∏–∑ –∫–æ–ª–æ–Ω–∫–∏.
    *   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç.

**–ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä—É—Ç–æ?** –í –∫–æ–¥–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤—ã –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç–µ `database.select(transactions).get()`. –í—ã –Ω–µ –¥—É–º–∞–µ—Ç–µ –æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑. –û–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–∞–º–æ.

---

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ (–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å)
–¢–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã, SQL-–¥–≤–∏–∂–æ–∫ (SQLite) –∏—Ö –Ω–µ "–≤–∏–¥–∏—Ç".

*   **–ß—Ç–æ –ù–ï–õ–¨–ó–Ø –¥–µ–ª–∞—Ç—å:** `SELECT * FROM transactions WHERE amount > 1000`.
    *   SQLite –Ω–µ –º–æ–∂–µ—Ç —Å—Ä–∞–≤–Ω–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞–π—Ç—ã —Å —á–∏—Å–ª–æ–º 1000.
*   **–ö–∞–∫ —ç—Ç–æ —Ä–µ—à–∞–µ—Ç—Å—è:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–≤ –ø–∞–º—è—Ç–∏** (In-Memory).
    1.  –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü, –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ç–∫—Ä—ã—Ç—É—é –∫–æ–ª–æ–Ω–∫—É `date`).
    2.  –û–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è.
    3.  –í Dart-–∫–æ–¥–µ –¥–µ–ª–∞–µ–º `.where((t) => t.amount > 1000)`.
    *   *–î–ª—è –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤ (–¥–∞–∂–µ 50,000 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π) —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å —ç—Ç–∏–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.*

---

### 4. Desktop-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞ (Windows/Linux)
–í –∑–∞–¥–∞–Ω–∏–∏ —É–ø–æ–º—è–Ω—É—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `sqlite3_flutter_libs`.
*   –ù–∞ Android/iOS SQLite –≤—Å—Ç—Ä–æ–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É.
*   –ù–∞ Windows/Linux –µ–≥–æ —á–∞—Å—Ç–æ –Ω–µ—Ç "–∏–∑ –∫–æ—Ä–æ–±–∫–∏" –∏–ª–∏ –≤–µ—Ä—Å–∏—è —Å—Ç–∞—Ä–∞—è.
*   –≠—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–ª–∞–¥–µ—Ç –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª `sqlite3.dll` (Windows) –∏–ª–∏ `libsqlite3.so` (Linux) –ø—Ä—è–º–æ –≤ –ø–∞–ø–∫—É —Å –≤–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π "Dll missing" –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.

---

### –ò—Ç–æ–≥ Stage 1
–í –∫–æ–Ω—Ü–µ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ —É –Ω–∞—Å –±—É–¥–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ–ª/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ù–æ –µ—Å–ª–∏ –º—ã –æ—Ç–∫—Ä–æ–µ–º —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`.sqlite`) —á–µ—Ä–µ–∑ "DB Browser for SQLite", –º—ã —É–≤–∏–¥–∏–º –¥–∞—Ç—ã –∏ ID, –Ω–æ –≤–º–µ—Å—Ç–æ –¥–µ–Ω–µ–≥ –∏ –æ–ø–∏—Å–∞–Ω–∏–π ‚Äî **–Ω–µ—á–∏—Ç–∞–µ–º—É—é –∫–∞—à—É –∏–∑ –±–∞–π—Ç–æ–≤**.



---------------------

## Stage 2 - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

---

### –ì–ª–∞–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: –ò–µ—Ä–∞—Ä—Ö–∏—è –ö–ª—é—á–µ–π

–í –æ–±—ã—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ **–ø–∞—Ä–æ–ª—å ‚Äî —ç—Ç–æ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**, –∫–æ—Ç–æ—Ä—ã–π –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∏–¥–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ (–¥–ª—è —Ü–µ–ª–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è).

–ú—ã —Å—Ç—Ä–æ–∏–º —Å–∏—Å—Ç–µ–º—É –∏–∑ –¥–≤—É—Ö —É—Ä–æ–≤–Ω–µ–π –∫–ª—é—á–µ–π:

1.  **Master Key (MK):**
    *   –≠—Ç–æ 32 –±–∞–π—Ç–∞ –∞–±—Å–æ–ª—é—Ç–Ω–æ —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Random Bytes).
    *   –ò–º–µ–Ω–Ω–æ —ç—Ç–∏–º –∫–ª—é—á–æ–º —à–∏—Ñ—Ä—É–µ—Ç—Å—è –≤—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQLite).
    *   **–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç –∫–ª—é—á –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è (–ø–æ–∫–∞ –º—ã –Ω–µ —Å–¥–µ–ª–∞–µ–º —Ä–æ—Ç–∞—Ü–∏—é –∫–ª—é—á–µ–π –≤ –±—É–¥—É—â–µ–º), –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏—Ç –ø–∞—Ä–æ–ª—å.

2.  **Key Encryption Key (KEK) ‚Äî –ö–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞:**
    *   –≠—Ç–æ—Ç –∫–ª—é—á *–≤—ã–≤–æ–¥–∏—Ç—Å—è* (derive) –∏–∑ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–º–æ—â—å—é –∞–ª–≥–æ—Ä–∏—Ç–º–∞ **Argon2id**.
    *   –û–Ω –Ω—É–∂–µ–Ω **—Ç–æ–ª—å–∫–æ** –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å Master Key –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –µ–≥–æ –≤ –æ–±–ª–∞–∫–æ.

---

### –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á (Tasks)

#### 1. CryptoService –∏ –ò–∑–æ–ª—è—Ç—ã (Isolates)

**–ó–∞–¥–∞—á–∞:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `deriveKeyFromPassword(password, salt)`.

*   **–ü–æ—á–µ–º—É Argon2id?** –≠—Ç–æ –∞–ª–≥–æ—Ä–∏—Ç–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, —É—Å—Ç–æ–π—á–∏–≤—ã–π –∫ –ø–µ—Ä–µ–±–æ—Ä—É –Ω–∞ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞—Ö (ASIC/GPU resistance). –û–Ω —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏. –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç —Ö–∞–∫–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–∫—Ä–∞–¥—É—Ç –±–∞–∑—É –∏ –ø–æ–ø—ã—Ç–∞—é—Ç—Å—è –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–∞—Ä–æ–ª–∏.
*   **–ó–∞—á–µ–º `compute()` (Isolate)?** –•–æ—Ä–æ—à–∏–π —Ö–µ—à Argon2id –¥–æ–ª–∂–µ–Ω –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –æ–∫–æ–ª–æ 0.5‚Äì1.0 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–µ. –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ Flutter (Main Thread), –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è "–∑–∞–º–µ—Ä–∑–Ω–µ—Ç" –Ω–∞ —Å–µ–∫—É–Ω–¥—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—É–º–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å–ª–æ. –ü–æ—ç—Ç–æ–º—É –º—ã –≤—ã–Ω–æ—Å–∏–º —ç—Ç—É —Ç—è–∂–µ–ª—É—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–∑–æ–ª—è—Ç.

#### 2. Auth Flow: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–°–æ–∑–¥–∞–Ω–∏–µ –•—Ä–∞–Ω–∏–ª–∏—â–∞)

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

1.  **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è MK:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ 32 –±–∞–π—Ç–∞. –≠—Ç–æ –Ω–∞—à "–°–≤—è—Ç–æ–π –ì—Ä–∞–∞–ª—å".
2.  **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è KEK:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∏–∑–æ–ª—è—Ç–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç `–ü–∞—Ä–æ–ª—å + –°–ª—É—á–∞–π–Ω–∞—è –°–æ–ª—å` –≤ `KEK`.
3.  **–°–æ–∑–¥–∞–Ω–∏–µ `vault.json`:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ—Ä–µ—Ç MK –∏ —à–∏—Ñ—Ä—É–µ—Ç –µ–≥–æ —Å –ø–æ–º–æ—â—å—é KEK. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π "blob".
4.  **–ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase:**
    *   –ú—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase Auth (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å `user_id`).
    *   –ú—ã –∑–∞–≥—Ä—É–∂–∞–µ–º —ç—Ç–æ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π blob (—Ñ–∞–π–ª `vault.json`) –≤ Supabase Storage.
    *   **–ò—Ç–æ–≥:** –°–µ—Ä–≤–µ—Ä Supabase –≤–∏–¥–∏—Ç —Ñ–∞–π–ª, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ ‚Äî –º—É—Å–æ—Ä. –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–Ω–∞–µ—Ç –Ω–∏ –ø–∞—Ä–æ–ª—è, –Ω–∏ Master Key.

#### 3. Auth Flow: –õ–æ–≥–∏–Ω (–ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É–ø–∏–ª –Ω–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ö–æ—á–µ—Ç –≤–æ–π—Ç–∏:

1.  **Supabase Auth:** –í–≤–æ–¥–∏—Ç email/–ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —É—á–µ—Ç–∫—É Supabase. –≠—Ç–æ –¥–∞–µ—Ç –ø—Ä–∞–≤–æ *—Å–∫–∞—á–∞—Ç—å* —Ñ–∞–π–ª.
2.  **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç `vault.json`.
3.  **–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
    *   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ "–ü–∞—Ä–æ–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è" (–æ–±—ã—á–Ω–æ —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞, –Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–º).
    *   –°–Ω–æ–≤–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Argon2id -> –ø–æ–ª—É—á–∞–µ–º KEK.
    *   –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å `vault.json` —Å –ø–æ–º–æ—â—å—é KEK.
    *   **–£—Å–ø–µ—Ö:** –ú—ã –¥–æ—Å—Ç–∞–ª–∏ Master Key! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    *   **–û—à–∏–±–∫–∞:** –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–Ω—ã–π, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (AES-GCM) –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (MAC check failed).

#### 4. Quick App Launch (–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥)

–í–≤–æ–¥–∏—Ç—å —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ—É–¥–æ–±–Ω–æ.

*   **–†–µ—à–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º **Master Key** –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –û–°.
    *   **iOS:** Keychain.
    *   **Android:** EncryptedSharedPreferences (Keystore).
    *   **Linux:** Libsecret (Gnome Keyring / KWallet). *–ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –≤ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö —É–∫–∞–∑–∞–Ω `libsecret-1-dev`.*
    *   **Windows:** DPAPI (—á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `flutter_secure_storage`).
*   **–õ–æ–≥–∏–∫–∞:** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç SecureStorage. –ï—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å MK ‚Äî –ø—É—Å–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–∏–ª–∏ –ø—Ä–æ—Å–∏–º –±–∏–æ–º–µ—Ç—Ä–∏—é). –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å–∏–º –ø–∞—Ä–æ–ª—å –∏ –∏–¥–µ–º –∑–∞ `vault.json`.

#### 5. "No Reset" Policy (–¢–æ—á–∫–∞ –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–∞)

–≠—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Å–ª–µ–¥—Å—Ç–≤–∏–µ Zero-Knowledge.

*   **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—ã–ª –ø–∞—Ä–æ–ª—å, –æ–Ω –Ω–µ –º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π KEK.
*   **–°–ª–µ–¥—Å—Ç–≤–∏–µ:** –û–Ω –Ω–µ –º–æ–∂–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å `vault.json`. –û–Ω –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∞—Ç—å Master Key. –î–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö –±–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.
*   **UI:** –ú—ã –æ–±—è–∑–∞–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞—à–Ω–æ–µ –∫—Ä–∞—Å–Ω–æ–µ –æ–∫–Ω–æ: *"–ú—ã –Ω–µ —Ö—Ä–∞–Ω–∏–º –≤–∞—à –ø–∞—Ä–æ–ª—å. –ï—Å–ª–∏ –≤—ã –µ–≥–æ –∑–∞–±—É–¥–µ—Ç–µ, –≤–∞—à–∏ –¥–µ–Ω—å–≥–∏ –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ."*

---

### –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?

1.  **–°–µ—Ä–≤–µ—Ä —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω:** –•–∞–∫–µ—Ä —Å–∫–∞—á–∏–≤–∞–µ—Ç `vault.json`. –ë–µ–∑ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) —ç—Ç–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ.
2.  **–ü–µ—Ä–µ—Ö–≤–∞—Ç —Ç—Ä–∞—Ñ–∏–∫–∞:** –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ HTTPS, –Ω–æ –¥–∞–∂–µ –µ—Å–ª–∏ SSL –≤–∑–ª–æ–º–∞–Ω, –≤–Ω—É—Ç—Ä–∏ –ª–µ–∂–∞—Ç —Ç–æ–ª—å–∫–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–±—ã.
3.  **–ü–æ–¥–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö:** –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (AES-GCM). –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ–ø—Ä–æ–±—É–µ—Ç –ø–æ–¥–º–µ–Ω–∏—Ç—å –±–∞–π—Ç—ã –≤ `vault.json`, –ø—Ä–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –≤—ã–ª–µ—Ç–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã–π –∫–ª—é—á.

### –ò—Ç–æ–≥ Stage 2

–ö –∫–æ–Ω—Ü—É —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –±—É–¥–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ:
1.  –£–º–µ–µ—Ç "–¥—Ä–æ–±–∏—Ç—å" –ø–∞—Ä–æ–ª—å —Ç—è–∂–µ–ª–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π, –Ω–µ —Ç–æ—Ä–º–æ–∑—è UI.
2.  –•—Ä–∞–Ω–∏—Ç –∫–ª—é—á–∏ —Ç–∞–∫, —á—Ç–æ –¥–∞–∂–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.
3.  –†–∞–±–æ—Ç–∞–µ—Ç —É–¥–æ–±–Ω–æ (–±–∏–æ–º–µ—Ç—Ä–∏—è/–∞–≤—Ç–æ-–≤—Ö–æ–¥) –±–ª–∞–≥–æ–¥–∞—Ä—è Secure Storage.
4.  –ì–æ—Ç–æ–≤–æ –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Ç–∞–∫ –∫–∞–∫ –∫–ª—é—á–∏ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∏ –æ–Ω–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞).

---------------------

## Stage 3 - –û—á–µ—Ä–µ–¥—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

### üèõ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Stage 3: "–ü–∞—Ç—Ç–µ—Ä–Ω Outbox"

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –ø–æ—á—Ç–æ–≤–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ.
–í **Stage 1** –º—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ —Å–∫–ª–∞–¥ (–õ–æ–∫–∞–ª—å–Ω—É—é –ë–î), –≥–¥–µ —Ö—Ä–∞–Ω–∏–º –ø–æ—Å—ã–ª–∫–∏.
–í **Stage 3** –º—ã —Å—Ç—Ä–æ–∏–º **–ñ—É—Ä–Ω–∞–ª –ò—Å—Ö–æ–¥—è—â–∏—Ö (Outbox)**.

#### –ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã —Ä–µ—à–∞–µ–º:
–ï—Å–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É `Transactions`, –∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–µ—Ç, –∫–∞–∫ –ø–æ—Ç–æ–º —É–∑–Ω–∞—Ç—å, *—á—Ç–æ –∏–º–µ–Ω–Ω–æ* –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∫–æ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è?
1.  –ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –±–∞–∑—É –∏ –∏—Å–∫–∞—Ç—å "–Ω–æ–≤—ã–µ" –∑–∞–ø–∏—Å–∏. (–î–æ–ª–≥–æ, –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ).
2.  –ê –µ—Å–ª–∏ —Ç—ã **—É–¥–∞–ª–∏–ª** –∑–∞–ø–∏—Å—å? –í –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ –µ—ë –±–æ–ª—å—à–µ –Ω–µ—Ç. –ö–∞–∫ —Å–µ—Ä–≤–µ—Ä —É–∑–Ω–∞–µ—Ç, —á—Ç–æ –µ—ë –Ω–∞–¥–æ —É–¥–∞–ª–∏—Ç—å?

#### –†–µ—à–µ–Ω–∏–µ: –¢–∞–±–ª–∏—Ü–∞ `SyncQueue`
–ú—ã —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ **–ª–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π**. –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ) –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ—Ç –ª–æ–≥.

---

### üõ† –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á Stage 3

#### 1. –¢–∞–±–ª–∏—Ü–∞ `SyncQueue` (–ñ—É—Ä–Ω–∞–ª)
–ú—ã —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ Drift (SQLite), –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç *–Ω–∞–º–µ—Ä–µ–Ω–∏—è*.

*   **`id` (Auto-Inc):** –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å–æ–±—ã—Ç–∏—è. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è —É–π–¥—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ–∏–∑–æ—à–ª–∏ (—Å–Ω–∞—á–∞–ª–∞ "–°–æ–∑–¥–∞–ª", –ø–æ—Ç–æ–º "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª").
*   **`operation` (Enum):**
    *   `UPSERT` (Insert or Update): "–Ø —Å–æ—Ö—Ä–∞–Ω–∏–ª –¥–∞–Ω–Ω—ã–µ".
    *   `DELETE`: "–Ø —É–¥–∞–ª–∏–ª –¥–∞–Ω–Ω—ã–µ".
*   **`row_id` (UUID):** ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –º—ã –º–µ–Ω—è–µ–º.
*   **`table_name`:** –°—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "transactions"). –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏. –ï—Å–ª–∏ –∑–∞–≤—Ç—Ä–∞ —Ç—ã –¥–æ–±–∞–≤–∏—à—å —Ç–∞–±–ª–∏—Ü—É "–°—á–µ—Ç–∞" –∏–ª–∏ "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", —Ç—ã –±—É–¥–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∂–µ –æ—á–µ—Ä–µ–¥—å, –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è—è –∏–º—è —Ç–∞–±–ª–∏—Ü—ã.
*   **`encrypted_payload` (Text/Blob):** –≠—Ç–æ **—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ**.
    *   –ú—ã —à–∏—Ñ—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ (JSON —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π) **—Å—Ä–∞–∑—É –∂–µ –≤ –º–æ–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**.
    *   –í –æ—á–µ—Ä–µ–¥—å –ø–æ–ø–∞–¥–∞–µ—Ç —É–∂–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π "–º—É—Å–æ—Ä".
    *   **–ó–∞—á–µ–º?** –ö–æ–≥–¥–∞ —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–≤–æ—Ä–∫–µ—Ä) –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –µ–º—É **–Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á**. –û–Ω –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –∫–∏–¥–∞–µ—Ç –µ—ë –≤ –æ–±–ª–∞–∫–æ. –≠—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

#### 2. Transaction Manager (–î–∏—Å–ø–µ—Ç—á–µ—Ä)
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤ –±–∞–∑—É –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `dao.insert()`. –ú—ã —Å–æ–∑–¥–∞–µ–º —Å–ª–æ–π-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫.

**–°—Ü–µ–Ω–∞—Ä–∏–π "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é" (Save):**
1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å".
2.  –ú–µ–Ω–µ–¥–∂–µ—Ä –±–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ.
3.  **–î–µ–π—Å—Ç–≤–∏–µ 1 (–õ–æ–∫–∞–ª—å–Ω–æ–µ):** –ü–∏—à–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É `Transactions` (—á—Ç–æ–±—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ).
4.  **–î–µ–π—Å—Ç–≤–∏–µ 2 (–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è):** –°–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON –∏ —à–∏—Ñ—Ä—É–µ—Ç –∏—Ö –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á–æ–º.
5.  **–î–µ–π—Å—Ç–≤–∏–µ 3 (–û—á–µ—Ä–µ–¥—å):** –ü–∏—à–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ `SyncQueue`:
    *   Op: `UPSERT`
    *   Payload: `[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π JSON]`

**–°—Ü–µ–Ω–∞—Ä–∏–π "–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é" (Delete):**
1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–£–¥–∞–ª–∏—Ç—å".
2.  **–î–µ–π—Å—Ç–≤–∏–µ 1 (–õ–æ–∫–∞–ª—å–Ω–æ–µ):** –ù–µ —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ñ–∏–∑–∏—á–µ—Å–∫–∏, –∞ —Å—Ç–∞–≤–∏—Ç —Ñ–ª–∞–≥ `is_deleted = true`. –≠—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è *Soft Delete*. –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –ª–æ–∫–∞–ª—å–Ω–æ –º—ã –∑–Ω–∞–ª–∏, —á—Ç–æ –∑–∞–ø–∏—Å—å –±—ã–ª–∞, –Ω–æ —É–¥–∞–ª–µ–Ω–∞.
3.  **–î–µ–π—Å—Ç–≤–∏–µ 2 (–û—á–µ—Ä–µ–¥—å):** –ü–∏—à–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ `SyncQueue`:
    *   Op: `DELETE`
    *   Payload: `null` (–∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π JSON). –ù–∞–º –Ω–µ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –∏—Ö, –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ ID.

#### 3. –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å (–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î)
–≠—Ç–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç —Å–±–æ–µ–≤.
–ü—Ä–µ–¥—Å—Ç–∞–≤—å:
1.  –ú—ã –∑–∞–ø–∏—Å–∞–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ `Transactions`.
2.  –ë–∞—Ç–∞—Ä–µ–π–∫–∞ —Å–µ–ª–∞ / –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–ª–æ.
3.  –í `SyncQueue` –∑–∞–ø–∏—Å—å –ø–æ–ø–∞—Å—Ç—å –Ω–µ —É—Å–ø–µ–ª–∞.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—Å—Ç—å, –Ω–æ –æ–Ω–∞ **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ —É–π–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏ –µ—ë –Ω–µ—Ç. –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω.

**–†–µ—à–µ–Ω–∏–µ:** –ú—ã –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –æ–¥–Ω—É SQL-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (`db.transaction(...)`).
*   –õ–∏–±–æ –æ–±–µ –∑–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
*   –õ–∏–±–æ (–ø—Ä–∏ –æ—à–∏–±–∫–µ) –æ—Ç–º–µ–Ω—è—é—Ç—Å—è –æ–±–µ.
–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.



---------------------

## Stage 4

---

---------------------

## Stage 5

---

---------------------

## Stage 6

---